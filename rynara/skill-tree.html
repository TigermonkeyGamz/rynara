<!-- =========================================
   RYNARA SKILL TREE EMBED DEV TOOL
========================================= -->

<style>
#rynaraViewport{
  position:relative;
  width:100%;
  height:100%;
  overflow:hidden;
  background:#111;
  font-family:sans-serif;
}

#rynaraWorld{
  position:absolute;
  left:50%;
  top:50%;
}

.skill{
  position:absolute;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:12px;
  text-align:center;
  background:#222;
  color:white;
  user-select:none;
  cursor:pointer;
}

.skill.locked{
  filter:grayscale(100%);
  opacity:.4;
}

canvas{
  position:absolute;
  left:0;
  top:0;
  pointer-events:none;
}

/* DEV BUTTON */
#devButton{
  position:absolute;
  right:10px;
  top:10px;
  width:22px;
  height:22px;
  background:#444;
  cursor:pointer;
  z-index:50;
}

/* DEV PANEL */
#devPanel{
  position:absolute;
  right:10px;
  top:40px;
  background:#222;
  color:white;
  padding:10px;
  display:none;
  z-index:100;
}
</style>

<div id="rynaraViewport">

<div id="devButton"></div>

<div id="devPanel">
  <b>DEV MODE</b><br>
  <button id="enableDev">Enable Editing</button>
</div>

<div id="rynaraWorld">
  <canvas id="grid"></canvas>
  <canvas id="lines"></canvas>
</div>

</div>

<script>

/* ===================
 CONFIG
=================== */
const DEV_PASSWORD="rynara-dev";
let DEV_MODE=false;

const gridSize=4000;
const gridCenter=gridSize/2;
const step=100;

/* ===================
 DOM
=================== */
const viewport=document.getElementById("rynaraViewport");
const world=document.getElementById("rynaraWorld");

const gridCanvas=document.getElementById("grid");
const gridCtx=gridCanvas.getContext("2d");

const lineCanvas=document.getElementById("lines");
const lineCtx=lineCanvas.getContext("2d");

gridCanvas.width=lineCanvas.width=gridSize;
gridCanvas.height=lineCanvas.height=gridSize;

/* ===================
 DEV PANEL
=================== */
const devPanel=document.getElementById("devPanel");

document.getElementById("devButton").onclick=()=>{
  devPanel.style.display=
  devPanel.style.display==="block"?"none":"block";
};

document.getElementById("enableDev").onclick=()=>{
  const pass=prompt("Dev Password?");
  if(pass===DEV_PASSWORD){
    DEV_MODE=true;
    alert("Dev Mode Enabled");
  }
};

/* ===================
 COORDS
=================== */
function worldX(x){return gridCenter+x;}
function worldY(y){return gridCenter-y;}

/* ===================
 SKILLS
=================== */
const skillData=[
  {id:'warrior',name:'Way of the Warrior',cost:2,parent:null,x:-200,y:0,size:45,borderColor:'#FF0000'},
  {id:'flurry',name:'Flurry',cost:3,parent:'warrior',x:-350,y:0,size:60,borderColor:'#FF0000'},
  {id:'jump',name:'Jump',cost:2,parent:'flurry',x:-550,y:-70,size:60,borderColor:'#FF0000'},
  {id:'p-parry',name:'Power Parry',cost:1,parent:'flurry',x:-550,y:70,size:60,borderColor:'#FF0000'},
  {id:'+block',name:'Increased Shield',cost:1,parent:'p-parry',x:-700,y:100,size:45,borderColor:'#FF0000'},
   {id:'+armor',name:'Increased Armor',cost:1,parent:'p-parry',x:-700,y:40,size:45,borderColor:'#FF0000'}
];

let unlocked=new Set();
const skillMap={};

/* ===================
 GRID
=================== */
function drawGrid(){
  gridCtx.clearRect(0,0,gridSize,gridSize);
  gridCtx.strokeStyle="#333";

  for(let x=0;x<=gridSize;x+=step){
    gridCtx.beginPath();
    gridCtx.moveTo(x,0);
    gridCtx.lineTo(x,gridSize);
    gridCtx.stroke();
  }

  for(let y=0;y<=gridSize;y+=step){
    gridCtx.beginPath();
    gridCtx.moveTo(0,y);
    gridCtx.lineTo(gridSize,y);
    gridCtx.stroke();
  }
}

/* ===================
 AVAILABILITY
=================== */
function available(skill){
  if(!skill.parent)return true;
  return unlocked.has(skill.parent);
}

/* ===================
 BUILD SKILLS
=================== */
function buildSkills(){

  skillData.forEach(skill=>{

    const div=document.createElement("div");
    div.className="skill";
    div.innerHTML=skill.name;

    div.style.width=skill.size+"px";
    div.style.height=skill.size+"px";
    div.style.border="3px solid "+skill.borderColor;

    positionSkill(div,skill);

    if(!available(skill))
      div.classList.add("locked");

    div.onclick=e=>{
      e.stopPropagation();
      if(!available(skill))return;
      unlocked.add(skill.id);
      refreshSkills();
    };

    enableSkillDrag(div,skill);

    world.appendChild(div);
    skillMap[skill.id]=div;
  });

}

function refreshSkills(){
  skillData.forEach(skill=>{
    const div=skillMap[skill.id];
    if(available(skill))div.classList.remove("locked");
    else div.classList.add("locked");
  });
  drawLines();
}

function positionSkill(div,skill){
  div.style.left=(worldX(skill.x)-skill.size/2)+"px";
  div.style.top=(worldY(skill.y)-skill.size/2)+"px";
}

/* ===================
 LINES
=================== */
function drawLines(){
  lineCtx.clearRect(0,0,gridSize,gridSize);
  lineCtx.strokeStyle="#888";
  lineCtx.lineWidth=2;

  skillData.forEach(skill=>{
    if(!skill.parent)return;
    const parent=skillData.find(s=>s.id===skill.parent);

    lineCtx.beginPath();
    lineCtx.moveTo(worldX(skill.x),worldY(skill.y));
    lineCtx.lineTo(worldX(parent.x),worldY(parent.y));
    lineCtx.stroke();
  });
}

/* ===================
 SKILL DRAG
=================== */
function enableSkillDrag(div,skill){

  let dragging=false;

  div.onmousedown=e=>{
    if(!DEV_MODE)return;
    dragging=true;
    e.stopPropagation();
  };

  window.addEventListener("mousemove",e=>{
    if(!dragging)return;

    skill.x+=e.movementX;
    skill.y-=e.movementY;

    positionSkill(div,skill);
    drawLines();
  });

  window.addEventListener("mouseup",()=>dragging=false);
}

/* ===================
 CAMERA
=================== */
let camX=0,camY=0;
let camDrag=false;

viewport.onmousedown=()=>camDrag=true;
window.onmouseup=()=>camDrag=false;

window.onmousemove=e=>{
  if(!camDrag)return;

  camX+=e.movementX;
  camY+=e.movementY;

  world.style.transform=
  `translate(calc(-50% + ${camX}px),calc(-50% + ${camY}px))`;
};

/* ===================
 INIT
=================== */
world.style.transform="translate(-50%,-50%)";
drawGrid();
buildSkills();
drawLines();

</script>
